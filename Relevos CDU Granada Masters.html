<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relevos CDU Granada Masters</title>
    <style>
      body {
          font-family: Arial, sans-serif;
          margin: 20px;
      }
      #homeButton {
          font-size: 2em;
          text-decoration: none;
          display: block;
          margin-bottom: 20px;
          width: 50px;
          text-align: left;
      }
      #logo {
          width: 200px;
          margin-bottom: 20px;
      }
      #filters {
          display: flex;
          gap: 20px;
          margin-bottom: 30px;
          align-items: center;
          padding: 10px;
          border: 1px solid #ddd;
          border-radius: 5px;
          background-color: #f9f9f9;
      }
      #filters label, #filters select {
          font-size: 1em;
      }
      #filters select {
          padding: 8px;
          border-radius: 4px;
          border: 1px solid #ccc;
      }
      table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 20px;
          font-size: 0.9em;
      }
      th, td {
          border: 1px solid #ccc;
          padding: 8px;
          text-align: center;
      }
      th {
          background-color: #007bff;
          color: white;
      }
      .time-col {
          white-space: nowrap;
          font-family: monospace;
          font-weight: bold;
      }
      .selected-stroke {
          background-color: #e0f7fa;
      }
    </style>
  </head>
  <body>
    
    <a href="index.html" id="homeButton" title="Volver a la calculadora">üè†</a>

    <img id="logo" src="CDU Granada.png" alt="CDU Granada Logo">

    <h1>Relevos CDU Granada Masters</h1>
    
    <div id="filters">
        <label for="genderFilter">G√©nero:</label>
        <select id="genderFilter" onchange="filterAndRenderTable()">
            <option value="Todos">Todos</option>
            <option value="H">Hombre</option>
            <option value="M">Mujer</option>
            <option value="Mixto">Mixto</option>
        </select>

        <label for="relayTypeFilter">Tipo de Relevo:</label>
        <select id="relayTypeFilter" onchange="filterAndRenderTable()">
            <option value="Libre">Libre (Crol)</option>
            <option value="Estilos">Estilos (Medley)</option>
        </select>

        <label for="lengthFilter">Longitud:</label>
        <select id="lengthFilter" onchange="filterAndRenderTable()">
            <option value="50">4x50</option>
            <option value="100">4x100</option>
            <option value="200">4x200</option>
        </select>
    </div>

    <div id="swimmerData">
      <p>Cargando datos de la hoja de c√°lculo...</p>
    </div>

    <script>
      // The direct export URL for your Google Sheet data as CSV
      const SHEET_URL = 'https://docs.google.com/spreadsheets/d/1kFZ04xvfnTW-lyxa9oeiZZqBTNC1SGPWkCNtgRy8zMk/gviz/tq?tqx=out:csv&gid=0';

      // Global variables to store the data once fetched
      let rawSwimmerData = [];
      let headers = [];

      // Helper function to convert time string (MM:SS.00) to total seconds
      function timeToSeconds(timeStr) {
          // Check for empty or invalid time format
          if (!timeStr || typeof timeStr !== 'string' || timeStr.indexOf(':') === -1) return Infinity; 
          const parts = timeStr.split(':');
          const minutes = parseInt(parts[0], 10) || 0;
          const seconds = parseFloat(parts[1]) || 0;
          return (minutes * 60) + seconds;
      }
      
      // Main function to fetch data from the Google Sheet
      function loadSwimmerData() {
          fetch(SHEET_URL)
              .then(response => {
                  if (!response.ok) {
                      throw new Error('Network response was not ok');
                  }
                  return response.text();
              })
              .then(csvText => {
                  const lines = csvText.trim().split("\n");
                  if (lines.length === 0) return;

                  // 1. Store headers (up to column M, which is the 13th column, index 12)
                  headers = lines[0].split(",").slice(0, 13);
                  
                  // 2. Store raw data rows
                  rawSwimmerData = lines.slice(1).map(line => line.split(",").slice(0, 13));

                  // 3. Render the table now that data is available
                  filterAndRenderTable();
              })
              .catch(error => {
                  console.error('Error fetching data from Google Sheet:', error);
                  document.getElementById('swimmerData').innerHTML = '<p style="color:red; font-weight:bold;">‚ö†Ô∏è Error al cargar los datos. Por favor, aseg√∫rese de que la hoja de c√°lculo es p√∫blica y el enlace de la hoja est√° en el primer tab ("gid=0").</p>';
              });
      }

      // Main function to parse, filter, and render the table (now uses global data)
      function filterAndRenderTable() {
          // If data hasn't been fetched yet, stop
          if (rawSwimmerData.length === 0) return;

          // Get filter selections
          const genderFilter = document.getElementById('genderFilter').value;
          const relayTypeFilter = document.getElementById('relayTypeFilter').value;
          const lengthFilter = document.getElementById('lengthFilter').value;

          // 1. Determine the columns needed for the selected relay length
          const lengthPrefix = lengthFilter + (lengthFilter === '50' ? '' : '0'); 
          const freeStyleCol = headers.findIndex(h => h === lengthPrefix + 'L'); 
          const backCol = headers.findIndex(h => h === lengthPrefix + 'E');      
          const flyCol = headers.findIndex(h => h === lengthPrefix + 'M');       
          const breastCol = headers.findIndex(h => h === lengthPrefix + 'B');    
          
          // Define the columns to always show (Name, Gender, Year Born)
          const fixedCols = [0, 1, 2];
          let strokeCols = [];

          if (relayTypeFilter === 'Libre') {
              strokeCols = [freeStyleCol];
          } else if (relayTypeFilter === 'Estilos') {
              // Estilos (Medley) requires times for Back, Fly, Breast, and Free (in that order for the relay calculation)
              strokeCols = [backCol, flyCol, breastCol, freeStyleCol]; 
          }

          const visibleColIndices = [...fixedCols, ...strokeCols];
          const filteredHeaders = visibleColIndices.map(index => headers[index]);

          // 2. Filter data by Gender
          let filteredData = rawSwimmerData.filter(row => {
              const swimmerGender = row[1]; // Gender is in column 1
              if (genderFilter === 'Todos' || genderFilter === 'Mixto') return true;
              return swimmerGender === genderFilter;
          });
          
          // 3. Sort data by best time (using the first required stroke for simplicity, which is Free/Crol time)
          if (strokeCols.length > 0) {
              const sortColIndex = strokeCols[0];
              filteredData.sort((a, b) => {
                  return timeToSeconds(a[sortColIndex]) - timeToSeconds(b[sortColIndex]);
              });
          }

          // 4. Generate Table HTML
          let tableHTML = '<table><thead><tr>';
          
          filteredHeaders.forEach(header => {
              tableHTML += `<th>${header}</th>`;
          });

          tableHTML += `<th>Tiempo Total</th>`;
          tableHTML += '</tr></thead><tbody>';

          // Process and display filtered data rows
          filteredData.forEach(row => {
              let totalSeconds = 0;
              let rowHTML = '<tr>';
              
              visibleColIndices.forEach((colIndex, index) => {
                  const cellValue = row[colIndex];
                  let className = '';
                  
                  if (strokeCols.includes(colIndex)) {
                      className = 'time-col';
                      totalSeconds += timeToSeconds(cellValue);

                      // Highlight the specific stroke time for the selected relay
                      if (relayTypeFilter === 'Libre' && headers[colIndex] === lengthPrefix + 'L') {
                          className += ' selected-stroke';
                      } 
                      if (relayTypeFilter === 'Estilos' && (headers[colIndex].endsWith('E') || headers[colIndex].endsWith('M') || headers[colIndex].endsWith('B') || headers[colIndex].endsWith('L'))) {
                           className += ' selected-stroke';
                      }
                  }

                  rowHTML += `<td class="${className}">${cellValue}</td>`;
              });

              // Calculate and format the Total Time
              const totalMinutes = Math.floor(totalSeconds / 60);
              const remainingSeconds = (totalSeconds % 60).toFixed(2).padStart(5, '0');
              const totalTimeDisplay = `${totalMinutes.toString().padStart(2, '0')}:${remainingSeconds}`;

              // Display Total Time
              rowHTML += `<td class="time-col">${totalTimeDisplay}</td>`; 
              rowHTML += '</tr>';
              tableHTML += rowHTML;
          });

          tableHTML += '</tbody></table>';
          document.getElementById('swimmerData').innerHTML = tableHTML;
      }

      // Start the data loading process when the page loads
      document.addEventListener('DOMContentLoaded', loadSwimmerData);
    </script>
  </body>
</html>
