<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relevos CDU Granada Masters</title>
    <style>
      body {
          font-family: Arial, sans-serif;
          margin: 20px;
      }
      #homeButton {
          font-size: 2em;
          text-decoration: none;
          display: block;
          margin-bottom: 20px;
          width: 50px;
          text-align: left;
      }
      #logo {
          width: 200px;
          margin-bottom: 20px;
      }
      table {
          width: 400px; /* Constrain width for simple table */
          border-collapse: collapse;
          margin-top: 20px;
          font-size: 1.1em;
      }
      th, td {
          border: 1px solid #ccc;
          padding: 10px;
          text-align: left;
      }
      th {
          background-color: #007bff;
          color: white;
      }
      td:last-child {
          text-align: center;
      }
    </style>
  </head>
  <body>
    
    <a href="index.html" id="homeButton" title="Volver a la calculadora">üè†</a>

    <img id="logo" src="CDU Granada.png" alt="CDU Granada Logo">

    <h1>Disponibilidad de Nadadores</h1>
    
    <div id="swimmerData">
      <p>Cargando datos de la hoja de c√°lculo...</p>
    </div>

    <script>
      // The direct export URL for your Google Sheet data as CSV
      const SHEET_URL = 'https://docs.google.com/spreadsheets/d/1kFZ04xvfnTW-lyxa9oeiZZqBTNC1SGPWkCNtgRy8zMk/gviz/tq?tqx=out:csv&gid=0';

      // Global variables to store the data once fetched
      let rawSwimmerData = [];
      let headers = [];

      // --- LOCAL STORAGE FUNCTIONS ---

      // Function to save the availability state of a swimmer
      function saveAvailability(swimmerName, isChecked) {
          try {
              // The key in local storage will be "availability_[Swimmer Name]"
              localStorage.setItem(`availability_${swimmerName}`, isChecked);
          } catch (e) {
              console.error("Error saving to local storage:", e);
          }
      }

      // Function to load the availability state of a swimmer
      function loadAvailability(swimmerName) {
          // Returns 'true'/'false' as a string, or null if not found
          return localStorage.getItem(`availability_${swimmerName}`);
      }

      // --- DATA FETCHING AND RENDERING ---

      // Main function to fetch data from the Google Sheet
      function loadSwimmerData() {
          fetch(SHEET_URL)
              .then(response => {
                  if (!response.ok) {
                      throw new Error('Network response was not ok');
                  }
                  return response.text();
              })
              .then(csvText => {
                  const lines = csvText.trim().split("\n");
                  if (lines.length === 0) return;

                  // 1. Store headers (up to column M, which is the 13th column, index 12)
                  headers = lines[0].split(",").slice(0, 13);
                  
                  // 2. Store raw data rows
                  rawSwimmerData = lines.slice(1).map(line => line.split(",").slice(0, 13));

                  // 3. Render the table now that data is available
                  renderAvailabilityTable();
              })
              .catch(error => {
                  console.error('Error fetching data from Google Sheet:', error);
                  document.getElementById('swimmerData').innerHTML = '<p style="color:red; font-weight:bold;">‚ö†Ô∏è Error al cargar los datos. Por favor, aseg√∫rese de que la hoja de c√°lculo es p√∫blica.</p>';
              });
      }

      // Function to render the simple Name and Checkbox table
      function renderAvailabilityTable() {
          if (rawSwimmerData.length === 0) return;

          const swimmerNameIndex = 0; // Column A: Nombre
          const availabilityHeader = headers[12]; // Column M: Disponible
          
          let tableHTML = '<table><thead><tr>';
          
          tableHTML += `<th>${headers[swimmerNameIndex]}</th>`;
          tableHTML += `<th>${availabilityHeader}</th>`;
          
          tableHTML += '</tr></thead><tbody>';

          // Process and display filtered data rows
          rawSwimmerData.forEach(row => {
              const swimmerName = row[swimmerNameIndex].replace(/"/g, ''); // Clean quotes from names
              
              // Load saved state from Local Storage, default to FALSE if not found
              const savedState = loadAvailability(swimmerName);
              let isChecked = savedState === 'true'; 

              // If the state is not in local storage, use the value from the sheet (if needed)
              // Note: For simplicity, we prioritize the local storage state.

              tableHTML += '<tr>';
              tableHTML += `<td>${swimmerName}</td>`;
              
              // Create the checkbox input
              tableHTML += `<td>
                              <input type="checkbox" 
                                     id="check_${swimmerName.replace(/\s/g, '_')}"
                                     ${isChecked ? 'checked' : ''}
                                     onchange="saveAvailability('${swimmerName}', this.checked)">
                            </td>`;
              
              tableHTML += '</tr>';
          });

          tableHTML += '</tbody></table>';
          document.getElementById('swimmerData').innerHTML = tableHTML;
      }

      // Start the data loading process when the page loads
      document.addEventListener('DOMContentLoaded', loadSwimmerData);
    </script>
  </body>
</html>
