<script>
      const SHEET_URL = 'https://docs.google.com/spreadsheets/d/1kFZ04xvfnTW-lyxa9oeiZZqBTNC1SGPWkCNtgRy8zMk/gviz/tq?tqx=out:csv&gid=0';
      // FIX 1: The Web App URL MUST be wrapped in quotes ('').
      const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwFODQqr1Vquiu3S6AJL-yCFEXgYHB_FXutupO0r-gNILICfzBPSfC_RpTOGwDX5cCveA/exec';

      let rawSwimmerData = [];
      let headers = [];
      let isFiltered = false; // Tracks the filter state

      // --- NEW LOCAL STORAGE & API FUNCTIONS (Keep these) ---
      
      // NEW: Function to send the update to the Apps Script API AND save locally
      function saveAvailability(swimmerName, isChecked) {
          // 1. Save to Local Storage (immediate feedback)
          try {
              localStorage.setItem(`availability_${swimmerName}`, isChecked);
          } catch (e) {
              console.error("Error saving to local storage:", e);
          }
          
          // 2. Send update to Google Sheet API
          fetch(WEB_APP_URL, {
              method: 'POST',
              mode: 'cors', 
              cache: 'no-cache',
              headers: {
                  'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                  name: swimmerName,
                  isAvailable: isChecked
              })
          })
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  console.log(`API Success: ${data.message}`);
              } else {
                  console.error(`API Error: ${data.error}`);
              }
          })
          .catch(error => {
              console.error('Fetch error when updating sheet:', error);
          });
      }

      function loadAvailability(swimmerName) {
          return localStorage.getItem(`availability_${swimmerName}`);
      }
      
      // NEW: Function to clear all saved availability statuses
      function resetAvailability() {
          if (!confirm("¿Estás seguro de que quieres resetear la disponibilidad de TODOS los nadadores?")) {
              return; 
          }
          
          // Note: The Apps Script needs a separate function to reset the whole sheet,
          // but this function correctly clears the LOCAL state.
          for (let i = 0; i < localStorage.length; i++) {
              const key = localStorage.key(i);
              if (key && key.startsWith('availability_')) { 
                  localStorage.removeItem(key);
              }
          }
          
          // Reset the filter state and re-render
          isFiltered = false;
          renderAvailabilityTable();
          
          // Reset the filter button appearance
          const filterButton = document.getElementById('filterButton');
          filterButton.textContent = 'Mostrar SÓLO Disponibles';
          filterButton.style.backgroundColor = '#28a745';
      }

      // --- DATA FETCHING AND RENDERING ---

      function loadSwimmerData() {
          fetch(SHEET_URL)
              // ... (rest of the loadSwimmerData function is correct) ...
              .then(response => {
                  if (!response.ok) {
                      throw new Error('Network response was not ok');
                  }
                  return response.text();
              })
              .then(csvText => {
                  const lines = csvText.trim().split("\n");
                  if (lines.length === 0) return;

                  headers = lines[0].split(",").slice(0, 13);
                  rawSwimmerData = lines.slice(1).map(line => line.split(",").slice(0, 13));

                  renderAvailabilityTable();
              })
              .catch(error => {
                  console.error('Error fetching data from Google Sheet:', error);
                  document.getElementById('swimmerData').innerHTML = '<p style="color:red; font-weight:bold;">⚠️ Error al cargar los datos. Por favor, asegúrese de que la hoja de cálculo es pública.</p>';
              });
      }
      
      // ... (toggleFilter function is correct) ...
      function toggleFilter() {
          isFiltered = !isFiltered;
          renderAvailabilityTable();
          
          const button = document.getElementById('filterButton');
          if (isFiltered) {
              button.textContent = 'Mostrar TODOS';
              button.style.backgroundColor = '#dc3545'; // Red color when showing filtered view
          } else {
              button.textContent = 'Mostrar SÓLO Disponibles';
              button.style.backgroundColor = '#28a745';
          }
      }


      // ... (renderAvailabilityTable function is correct) ...
      function renderAvailabilityTable() {
          if (rawSwimmerData.length === 0) return;

          const swimmerNameIndex = 0;
          const availabilityHeader = headers[12];
          
          const dataToRender = rawSwimmerData.filter(row => {
              const swimmerName = row[swimmerNameIndex].replace(/"/g, ''); 
              const savedState = loadAvailability(swimmerName);
              const isChecked = savedState === 'true';

              return !isFiltered || isChecked; 
          });
          
          let tableHTML = '<table><thead><tr>';
          tableHTML += `<th>${headers[swimmerNameIndex]}</th>`;
          tableHTML += `<th>${availabilityHeader}</th>`;
          tableHTML += '</tr></thead><tbody>';

          dataToRender.forEach(row => {
              const swimmerName = row[swimmerNameIndex].replace(/"/g, '');
              const savedState = loadAvailability(swimmerName);
              let isChecked = savedState === 'true';

              tableHTML += '<tr>';
              tableHTML += `<td>${swimmerName}</td>`;
              
              tableHTML += `<td>
                                <input type="checkbox" 
                                       id="check_${swimmerName.replace(/\s/g, '_')}"
                                       ${isChecked ? 'checked' : ''}
                                       onchange="saveAvailability('${swimmerName}', this.checked)">
                              </td>`;
              
              tableHTML += '</tr>';
          });

          tableHTML += '</tbody></table>';
          document.getElementById('swimmerData').innerHTML = tableHTML;
      }

      // Start the data loading process when the page loads
      document.addEventListener('DOMContentLoaded', () => {
          loadSwimmerData();
          document.getElementById('filterButton').addEventListener('click', toggleFilter);
          document.getElementById('resetButton').addEventListener('click', resetAvailability);
      });
    </script>
