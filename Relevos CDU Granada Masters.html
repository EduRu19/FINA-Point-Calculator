<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relevos CDU Granada Masters</title>
    <style>
      body {
          font-family: Arial, sans-serif;
          margin: 20px;
      }
      #homeButton {
          font-size: 2em;
          text-decoration: none;
          display: block;
          margin-bottom: 20px;
          width: 50px;
          text-align: left;
      }
      #logo {
          width: 200px;
          margin-bottom: 20px;
      }
      /* New and updated button styles */
      #filterButton, #resetButton {
          padding: 10px 15px;
          font-size: 1em;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          margin-right: 10px; /* Space between buttons */
          margin-bottom: 20px;
          transition: background-color 0.2s;
          /* Requested styling */
          color: black;
          font-weight: bold;
      }

      #filterButton {
          background-color: #28a745; /* Green color for 'Available' */
      }

      #filterButton:hover {
          background-color: #218838;
      }
      
      #resetButton {
          background-color: #ffc107; /* Yellow/Warning color for Reset */
      }

      #resetButton:hover {
          background-color: #e0a800;
      }
      
      /* Table styles */
      table {
          width: 400px; /* Constrain width for simple table */
          border-collapse: collapse;
          margin-top: 20px;
          font-size: 1.1em;
      }
      th, td {
          border: 1px solid #ccc;
          padding: 10px;
          text-align: left;
      }
      th {
          background-color: #007bff;
          color: white;
      }
      td:last-child {
          text-align: center;
      }
    </style>
  </head>
  <body>
    
    <a href="index.html" id="homeButton" title="Volver a la calculadora">üè†</a>

    <img id="logo" src="CDU Granada.png" alt="CDU Granada Logo">

    <h1>Disponibilidad de Nadadores</h1>
    
    <button id="filterButton">Mostrar S√ìLO Disponibles</button>
    <button id="resetButton">Resetear Disponibilidad</button>
    
    <div id="swimmerData">
      <p>Cargando datos de la hoja de c√°lculo...</p>
    </div>

    <script>
      const SHEET_URL = 'https://docs.google.com/spreadsheets/d/1kFZ04xvfnTW-lyxa9oeiZZqBTNC1SGPWkCNtgRy8zMk/gviz/tq?tqx=out:csv&gid=0';

      let rawSwimmerData = [];
      let headers = [];
      let isFiltered = false; // Tracks the filter state

      // --- LOCAL STORAGE FUNCTIONS ---

      function saveAvailability(swimmerName, isChecked) {
          try {
              localStorage.setItem(`availability_${swimmerName}`, isChecked);
          } catch (e) {
              console.error("Error saving to local storage:", e);
          }
      }

      function loadAvailability(swimmerName) {
          return localStorage.getItem(`availability_${swimmerName}`);
      }
      
      // NEW: Function to clear all saved availability statuses
      function resetAvailability() {
          if (!confirm("¬øEst√°s seguro de que quieres resetear la disponibilidad de TODOS los nadadores?")) {
              return; 
          }

          for (let i = 0; i < localStorage.length; i++) {
              const key = localStorage.key(i);
              if (key && key.startsWith('availability_')) { // Check for key existence and prefix
                  localStorage.removeItem(key);
              }
          }
          
          // Reset the filter state and re-render
          isFiltered = false;
          renderAvailabilityTable();
          
          // Reset the filter button appearance
          const filterButton = document.getElementById('filterButton');
          filterButton.textContent = 'Mostrar S√ìLO Disponibles';
          filterButton.style.backgroundColor = '#28a745';
      }

      // --- DATA FETCHING AND RENDERING ---

      function loadSwimmerData() {
          fetch(SHEET_URL)
              .then(response => {
                  if (!response.ok) {
                      throw new Error('Network response was not ok');
                  }
                  return response.text();
              })
              .then(csvText => {
                  const lines = csvText.trim().split("\n");
                  if (lines.length === 0) return;

                  headers = lines[0].split(",").slice(0, 13);
                  rawSwimmerData = lines.slice(1).map(line => line.split(",").slice(0, 13));

                  renderAvailabilityTable();
              })
              .catch(error => {
                  console.error('Error fetching data from Google Sheet:', error);
                  document.getElementById('swimmerData').innerHTML = '<p style="color:red; font-weight:bold;">‚ö†Ô∏è Error al cargar los datos. Por favor, aseg√∫rese de que la hoja de c√°lculo es p√∫blica.</p>';
              });
      }
      
      // NEW: Function to toggle the filter and re-render the table
      function toggleFilter() {
          isFiltered = !isFiltered;
          renderAvailabilityTable();
          
          const button = document.getElementById('filterButton');
          if (isFiltered) {
              button.textContent = 'Mostrar TODOS';
              button.style.backgroundColor = '#dc3545'; // Red color when showing filtered view
          } else {
              button.textContent = 'Mostrar S√ìLO Disponibles';
              button.style.backgroundColor = '#28a745';
          }
      }


      function renderAvailabilityTable() {
          if (rawSwimmerData.length === 0) return;

          const swimmerNameIndex = 0;
          const availabilityHeader = headers[12];
          
          // Apply filter based on isFiltered state
          const dataToRender = rawSwimmerData.filter(row => {
              const swimmerName = row[swimmerNameIndex].replace(/"/g, ''); 
              const savedState = loadAvailability(swimmerName);
              const isChecked = savedState === 'true';

              // If filter is OFF, show all. If filter is ON, show only checked swimmers.
              return !isFiltered || isChecked; 
          });
          
          let tableHTML = '<table><thead><tr>';
          tableHTML += `<th>${headers[swimmerNameIndex]}</th>`;
          tableHTML += `<th>${availabilityHeader}</th>`;
          tableHTML += '</tr></thead><tbody>';

          dataToRender.forEach(row => {
              const swimmerName = row[swimmerNameIndex].replace(/"/g, '');
              const savedState = loadAvailability(swimmerName);
              let isChecked = savedState === 'true';

              tableHTML += '<tr>';
              tableHTML += `<td>${swimmerName}</td>`;
              
              // Note: The onchange listener remains the same, saving to local storage.
              tableHTML += `<td>
                                <input type="checkbox" 
                                       id="check_${swimmerName.replace(/\s/g, '_')}"
                                       ${isChecked ? 'checked' : ''}
                                       onchange="saveAvailability('${swimmerName}', this.checked)">
                              </td>`;
              
              tableHTML += '</tr>';
          });

          tableHTML += '</tbody></table>';
          document.getElementById('swimmerData').innerHTML = tableHTML;
      }

      // Start the data loading process when the page loads
      document.addEventListener('DOMContentLoaded', () => {
          loadSwimmerData();
          // Event Listeners for the new buttons
          document.getElementById('filterButton').addEventListener('click', toggleFilter);
          document.getElementById('resetButton').addEventListener('click', resetAvailability);
      });
    </script>
  </body>
</html>
