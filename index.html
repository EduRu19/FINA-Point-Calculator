<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FINA Points Calculator CDU Granada</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        form {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-top: 10px;
        }
        input, select, button {
            margin-top: 5px;
            padding: 5px;
            font-size: 1em;
        }
        #result {
            margin-top: 20px;
            font-size: 1.2em;
            font-weight: bold;
        }
    </style>
  </head>
  <body>
    <h1>FINA Points Calculator CDU Granada</h1>
    <form id="finaForm">
      <label for="poolType">Pool Type:</label>
      <select id="poolType" required>
        <option value="25m">25m Pool</option>
        <option value="50m">50m Pool</option>
      </select>
      
      <label for="time">Time (MM:SS.00):</label>
      <input id="time" placeholder="Enter time (e.g., 01:05.23)" required type="text">

      <label for="event">Swim Event:</label>
      <select id="event" required>
        <option value="">Loading events...</option>
      </select>

      <label for="gender">Gender:</label>
      <select id="gender" required>
        <option value="">Select Gender</option>
        <option value="Masculino">Masculino</option>
        <option value="Femenino">Femenino</option>
      </select>

      <label for="ageGroup">Age Group:</label>
      <select id="ageGroup" required>
        <option value="">Select Age Group</option>
        <option value="20-24">20-24</option>
        <option value="25-29">25-29</option>
        <option value="30-34">30-34</option>
        <option value="35-39">35-39</option>
        <option value="40-44">40-44</option>
        <option value="45-49">45-49</option>
        <option value="50-54">50-54</option>
        <option value="55-59">55-59</option>
        <option value="60-64">60-64</option>
        <option value="65-69">65-69</option>
        <option value="70-74">70-74</option>
        <option value="75-79">75-79</option>
      </select>

      <button type="button" onclick="calculateFINA()">Calculate Points</button>
      <button type="button" onclick="showWorldRecord()">Show World Record</button>
    </form>
    <div id="result"></div>
    <div id="recordDisplay"></div>
    <script>
        let worldRecords = {}; // Object to store world records dynamically loaded

        // Load records from CSV based on pool type
        function loadRecords(poolType) {
            const fileName = poolType === "25m" ? "short_course_records.csv" : "long_course_records.csv";

            fetch(fileName)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Failed to load ${fileName}`);
                    }
                    return response.text();
                })
                .then(csvText => {
                    parseCSV(csvText);
                    loadEvents();
                })
                .catch(error => {
                    console.error(error);
                    document.getElementById("event").innerHTML = '<option value="">Failed to load events</option>';
                });
        }

        // Parse CSV into worldRecords object
        function parseCSV(csvText) {
            worldRecords = {}; // Clear previous records
            const lines = csvText.split("\n").map(line => line.trim());
            lines.forEach(line => {
                const [event, gender, ageGroup, minutes, seconds, decimals] = line.split(",");
                const key = `${event}_${gender}_${ageGroup}`;
                const recordTime = parseInt(minutes, 10) * 60 + parseInt(seconds, 10) + parseFloat(decimals) / 100;
                worldRecords[key] = recordTime; // Store record in seconds
            });
        }

        // Populate swim events based on loaded worldRecords
        function loadEvents() {
            const uniqueEvents = new Set();
            for (const key in worldRecords) {
                const [event] = key.split("_");
                uniqueEvents.add(event);
            }

            const eventSelect = document.getElementById("event");
            eventSelect.innerHTML = Array.from(uniqueEvents)
                .map(event => `<option value="${event}">${event}</option>`)
                .join('');
        }

        function showWorldRecord() {
            const poolType = document.getElementById("poolType").value.trim();
            const event = document.getElementById("event").value.trim();
            const gender = document.getElementById("gender").value.trim();
            const ageGroup = document.getElementById("ageGroup").value.trim();

            if (!event || !gender || !ageGroup) {
                document.getElementById("recordDisplay").textContent = "Please select all fields to view the world record.";
                return;
            }

            const recordKey = `${event}_${gender}_${ageGroup}`;
            const worldRecord = worldRecords[recordKey];

            if (!worldRecord) {
                document.getElementById("recordDisplay").textContent = "World record not found for selected criteria.";
            } else {
                const recordMinutes = Math.floor(worldRecord / 60);
                const recordSeconds = (worldRecord % 60).toFixed(2);
                const formattedRecord = `${recordMinutes}:${recordSeconds.padStart(5, "0")}`;
                
                document.getElementById("recordDisplay").textContent = `World Record Time: ${formattedRecord}`;
            }
        }

        function calculateFINA() {
            const poolType = document.getElementById("poolType").value.trim();
            const timeInput = document.getElementById("time").value.trim();
            const event = document.getElementById("event").value.trim();
            const gender = document.getElementById("gender").value.trim();
            const ageGroup = document.getElementById("ageGroup").value.trim();

            if (!timeInput || !event || !gender || !ageGroup) {
                document.getElementById("result").textContent = "Please fill out all fields.";
                return;
            }

            const timeParts = timeInput.split(":");
            if (timeParts.length !== 2) {
                document.getElementById("result").textContent = "Invalid time format. Use MM:SS.00.";
                return;
            }

            const minutes = parseInt(timeParts[0], 10);
            const seconds = parseFloat(timeParts[1]);
            const totalTime = minutes * 60 + seconds;

            const recordKey = `${event}_${gender}_${ageGroup}`;
            const worldRecord = worldRecords[recordKey];

            if (!worldRecord) {
                document.getElementById("result").textContent = "World record not found for selected criteria.";
                return;
            }

            const points = 1000 * Math.pow(worldRecord / totalTime, 3);
            document.getElementById("result").textContent = `FINA Points: ${points.toFixed(2)}`;
        }

        document.getElementById("poolType").addEventListener("change", (event) => {
            const poolType = event.target.value;
            loadRecords(poolType);
        });

        document.addEventListener("DOMContentLoaded", () => {
            loadRecords("25m"); // Load 25m pool records by default
        });
    </script>
  </body>
</html>
